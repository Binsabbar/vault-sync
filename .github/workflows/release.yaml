name: release

on:
  # added for testing release workflow and restricted to alpha releases only
  push:
    branches:
      - "releases/v[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+"
  pull_request:
    types: [closed]
    branches:
      - "releases/v[0-9]+.[0-9]+.[0-9]+"
      - "releases/v[0-9]+.[0-9]+.[0-9]+-rc.[0-9]+"
      - "releases/v[0-9]+.[0-9]+.[0-9]+-beta.[0-9]+"
      - "releases/v[0-9]+.[0-9]+.[0-9]+-alpha.[0-9]+"
  # workflow_dispatch:
  #   inputs:
  #     branch:
  #       description: "Release branch name (e.g., releases/v1.2.3)"
  #       required: true
  #       type: string
  #     pr_number:
  #       description: "PR number (optional, for context)"
  #       required: false
  #       type: string

jobs:
  # test:
  #   if: github.event_name == 'workflow_dispatch'
  #   uses: ./.github/workflows/test.yaml

  # lint:
  #   if: github.event_name == 'workflow_dispatch'
  #   uses: ./.github/workflows/golangci-lint.yaml

  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
      id-token: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'pull_request' && github.event.pull_request.base.ref || github.ref }}

      - name: Extract version from branch name
        id: get_version
        run: |
          if [ "${{ github.event_name }}" == "push" ]; then
            BRANCH="${{ github.ref }}"
            TRIGGER="Manual workflow dispatch"
          else
            # PR merged into release branch
            BRANCH="${{ github.event.pull_request.base.ref }}"
            PR_NUMBER="${{ github.event.pull_request.number }}"
            PR_TITLE="${{ github.event.pull_request.title }}"
            TRIGGER="PR #${PR_NUMBER} merged: ${PR_TITLE}"
          fi

          # Extract version from branch name (releases/v1.2.3 -> v1.2.3)
          VERSION=$(echo "${BRANCH}" | sed 's|^releases/||')

          echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "üöÄ Preparing release for version: ${VERSION}"
          echo "üì¶ From branch: ${BRANCH}"
          echo "üîÄ Triggered by: ${TRIGGER}"

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.24"
          cache: true
          cache-dependency-path: |
            go.sum
            go.mod

      - name: Install dependencies
        run: go mod download

      - name: Create Git Tag
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          echo "üè∑Ô∏è Creating tag: ${VERSION}"

          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "${VERSION}" -m "Release ${VERSION}"
          git push origin "${VERSION}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.repository_owner }}
          password: ${{ secrets.GITHUB_TOKEN }}


      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GORELEASER_CURRENT_TAG: ${{ steps.get_version.outputs.version }}

      # - name: Build and push Docker images
      #   run: |
      #     VERSION=${{ steps.get_version.outputs.version }}
      #     make docker-build-and-push VERSION=${VERSION}
      #   env:
      #     DOCKER_REGISTRY: ghcr.io
      #     DOCKER_IMAGE_NAME: ${{ github.repository }}

      # - name: Create GitHub Release with Tag
      #   uses: softprops/action-gh-release@v2
      #   with:
      #     tag_name: ${{ steps.get_version.outputs.version }}
      #     name: Release ${{ steps.get_version.outputs.version }}
      #     body_path: ${{ steps.changelog.outputs.changelog_file }}
      #     draft: false
      #     prerelease: ${{ contains(steps.get_version.outputs.version, '-rc') || contains(steps.get_version.outputs.version, '-beta') || contains(steps.get_version.outputs.version, '-alpha') }}
      #     files: |
      #       dist/*.tar.gz
      #       dist/*.zip
      #       dist/checksums.txt
      #     generate_release_notes: true
      #     append_body: true
      #     make_latest: ${{ !contains(steps.get_version.outputs.version, '-rc') && !contains(steps.get_version.outputs.version, '-beta') && !contains(steps.get_version.outputs.version, '-alpha') }}
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Release Summary
        run: |
          VERSION=${{ steps.get_version.outputs.version }}
          echo "‚úÖ Release ${VERSION} created successfully!"
          echo "üì¶ GitHub Release: https://github.com/${{ github.repository }}/releases/tag/${VERSION}"
          echo "üê≥ Docker Image: ghcr.io/${{ github.repository }}:${VERSION}"
          if [[ "${VERSION}" != *"-rc"* ]] && [[ "${VERSION}" != *"-beta"* ]] && [[ "${VERSION}" != *"-alpha"* ]]; then
            echo "üê≥ Docker Latest: ghcr.io/${{ github.repository }}:latest"
          fi

          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "üîÄ Released from PR #${{ github.event.pull_request.number }}"
            echo "üë§ Merged by: ${{ github.event.pull_request.merged_by.login }}"
          fi
